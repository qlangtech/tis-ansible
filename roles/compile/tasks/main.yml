---
# tasks file for compile
  - name: judge maven is deployed
    shell: ls {{mvn_home}}/conf/setting.xml
    ignore_errors: True
    register: ismvndeploy
    
  - name: get maven package
    get_url:
      url: "{{release_repository}}/{{item}}"
      dest: "/tmp/{{item}}"
    with_items:
      - "{{mvn_zip_package_name}}"
    when: ismvndeploy is failed
  
  - name: make {{mvn_home}}
    file:
     path: "{{mvn_home}}"
     state: directory
  
  - name: deploy maven builder
    unarchive:
      src: '/tmp/{{mvn_zip_package_name}}'
      dest: '{{mvn_home}}'
      remote_src: yes
    when: ismvndeploy is failed
    
  - template:
     src: template/settings.xml.j2
     dest: '{{mvn_home}}/conf/settings.xml'
    when: ismvndeploy is failed
   
  - name: mkdir
    file:
     path: "{{src_dir}}"
     state: directory

  - name: git pull
    git:
     repo: '{{git_src}}'
     dest: '{{src_dir}}'
     version: '{{git_branch}}'
  
  - name: copy compile shell script
    template:
     src: template/compile.sh.j2
     dest: '{{src_dir}}/compile.sh'
     mode: u+rwx

  - name: compile and package
    command: ./compile.sh {{runtime}} {{appname}}
    args:
     chdir: "{{src_dir}}"